# Story 2.2: Data Collectors for Remaining Telco Sources

## Status
Ready

## Story
**As a** developer,
**I want** data collectors for all 7 telco sources (O2, Vodafone, Sky, Tesco, Smarty, Three, Giffgaff),
**so that** complete competitive data can be collected.

## Acceptance Criteria

1. Individual collector modules created for each remaining telco (6 new + 1 from POC):
   - **Playwright scrapers**: Vodafone, Sky, Tesco, Three, Giffgaff (+ O2 from POC)
   - **API integration**: Smarty (REST API endpoint)
2. Each collector extracts: pricing, data allowance, contract term, promotional extras
3. Playwright scrapers handle:
   - Cookie consent modals (site-specific selectors)
   - Multiple contract lengths where applicable (e.g., 1/12/24 months)
   - Modal interactions for extended details (e.g., Vodafone tabs)
   - Browser selection (webkit vs chromium based on compatibility)
4. Each collector handles source-specific edge cases and layout variations
5. Error handling implemented per collector (fail fast with logging - no retry logic)
6. All collectors write raw scraped data to `plans` table:
   - `id`: UUID (auto-generated by database)
   - `source`: TEXT (telco name, e.g., 'O2', 'Vodafone')
   - `plan_data`: JSONB (raw extracted data - no normalization yet)
   - `scrape_timestamp`: TIMESTAMPTZ (auto-generated by database)
   - `plan_key`: NULL (will be populated in Story 2.5 after normalization)
   - **Note**: Data stored in raw format. Story 2.5 will add normalization layer.
7. Unit tests for each collector (mocked page content or API responses)
8. `npm run scrape:telcos` command runs all 7 telco collectors sequentially

## Tasks / Subtasks

- [ ] Create collector modules (AC: 1)
  - [ ] Create `src/lib/scraping/collectors/vodafone.ts`
  - [ ] Create `src/lib/scraping/collectors/sky.ts`
  - [ ] Create `src/lib/scraping/collectors/tesco.ts`
  - [ ] Create `src/lib/scraping/collectors/three.ts`
  - [ ] Create `src/lib/scraping/collectors/giffgaff.ts`
  - [ ] Create `src/lib/scraping/collectors/smarty.ts` (API integration)
  - [ ] Update O2 collector from POC (if needed)
- [ ] Implement Playwright scrapers (AC: 2, 3)
  - [ ] Extract pricing, data allowance, contract term, extras for each
  - [ ] Handle cookie consent modals (site-specific)
  - [ ] Handle multiple contract lengths where applicable
  - [ ] Handle modal interactions (e.g., Vodafone tabs)
  - [ ] Choose appropriate browser (webkit vs chromium)
- [ ] Implement Smarty API integration (AC: 2)
  - [ ] Create REST API client for Smarty
  - [ ] Fetch plan data from API endpoint
  - [ ] Extract required fields
- [ ] Handle edge cases (AC: 4)
  - [ ] Handle source-specific layout variations
  - [ ] Handle missing data gracefully
  - [ ] Document edge cases per source
- [ ] Implement error handling (AC: 5)
  - [ ] Handle timeout errors
  - [ ] Handle element not found errors
  - [ ] Add error logging (fail fast approach)
- [ ] Store raw data in database (AC: 6)
  - [ ] Write collected data to `plans` table as raw JSONB
  - [ ] Include source name in each record
  - [ ] Leave plan_key NULL (will be populated in Story 2.5)
  - [ ] Handle database errors
- [ ] Write unit tests (AC: 7)
  - [ ] Create test files for each collector in `src/lib/scraping/collectors/__tests__/`
  - [ ] Mock Playwright page content or API responses
  - [ ] Test data extraction logic
  - [ ] Test error handling
  - [ ] Use Vitest (project standard)
- [ ] Create npm script (AC: 8)
  - [ ] Add `scrape:telcos` script to `package.json`
  - [ ] Implement sequential execution of all 7 collectors
  - [ ] Test script execution

## Dev Notes

### Source Tree
- Collectors: `src/lib/scraping/collectors/{telco}.ts`
- Database: `src/lib/db/` (from Story 1.2, 2.1)
- Test files: `src/lib/scraping/collectors/__tests__/{telco}.test.ts`

### Technical Stack
- Playwright for browser automation (6 telcos)
- REST API client (fetch) for Smarty
- PostgreSQL for data storage (raw JSONB format)
- Vitest for testing (project standard)

### Data Storage Strategy
**Raw data approach** (normalization deferred to Story 2.5):
- Store scraped data directly in `plan_data` JSONB field
- No transformation or normalization applied
- Allows Story 2.5 to analyze actual format variations
- `plan_key` left NULL until normalization layer added

Example raw plan_data:
```json
{
  "name": "Big Value Bundle",
  "price": "£10/month",
  "data_allowance": "10GB",
  "contract_term": "12 months",
  "extras": ["Free calls", "EU roaming"]
}
```

### Testing
- Test file location: `src/lib/scraping/collectors/__tests__/` (co-located with collectors)
- Test framework: Vitest (aligned with project standards Stories 1.2, 1.3, 2.1)
- Mock Playwright page responses to avoid hitting real websites
- Test each collector individually
- Coverage target: 60%+ for scraping logic

### Relationship to Story 2.5

**Story 2.2** (this story):
- Focus: Collect raw data from all 7 telco sources
- Scope: Scraping logic, error handling, database insertion
- Output: Raw plan data stored in `plan_data` JSONB field
- `plan_key`: NULL (not generated yet)

**Story 2.5** (Data Normalization Before Storage):
- Focus: Add normalization layer before database insertion
- Timing: After Stories 2.2-2.4 complete (needs real data formats)
- Scope: Normalize data, generate `plan_key` values
- Output: Will update collectors to call normalization before storage

Story 2.2 provides the raw data collection. Story 2.5 will add normalization based on actual format variations discovered.

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Story extracted from PRD | Architect |
| 2025-01-17 | 1.1 | Removed normalization dependency (moved to Story 2.5), updated testing strategy to Vitest, fixed plan_key/plan_id confusion, clarified raw data storage approach | PM Agent (John) |

## Dev Agent Record

### Agent Model Used
_To be populated by Dev Agent_

### Debug Log References
_To be populated by Dev Agent_

### Completion Notes List
_To be populated by Dev Agent_

### File List

**Database Layer:**
- `src/lib/db/plans.ts` - Database operations for plan insertion
  - `insertPlan()` - Insert single plan with raw data
  - `insertPlans()` - Batch insert with transaction support
  - All insertions set `plan_key=NULL` (normalization in Story 2.5)

**Collector Implementations:**
- `src/lib/scraping/collectors/o2.ts` - ✅ Full Playwright implementation
  - `scrapeAndStoreO2Plans()` - Scrapes 3 contract lengths (1/12/24 months)
  - Returns count of inserted plans (33 plans typical)
- `src/lib/scraping/collectors/smarty.ts` - ✅ Full API implementation
  - `scrapeAndStoreSmartyPlans()` - Fetches from Smarty REST API
  - Returns count of inserted plans (32 plans typical)
  - Uses fetch with proper headers for API authentication
  - Maps API response to PlanData format with standard benefits
- `src/lib/scraping/collectors/vodafone.ts` - **STUB** - TODO: Playwright implementation
- `src/lib/scraping/collectors/sky.ts` - **STUB** - TODO: Playwright implementation
- `src/lib/scraping/collectors/tesco.ts` - **STUB** - TODO: Playwright implementation
- `src/lib/scraping/collectors/three.ts` - **STUB** - TODO: Playwright implementation
- `src/lib/scraping/collectors/giffgaff.ts` - **STUB** - TODO: Playwright implementation

**Orchestration:**
- `src/scripts/scrape-telcos.ts` - Runs all 7 collectors sequentially
  - Exports `CollectorResult` interface and `runAllCollectors()` function
  - Error handling per collector (one failure doesn't stop others)
  - Summary output with duration, counts, and per-source status
  - Exit code 1 if any collector fails
- **npm script:** `npm run scrape:telcos`

**Tests:**
- `src/lib/db/__tests__/plans.test.ts` - 8 comprehensive database tests
  - Single insert, batch insert, empty array handling
  - Large batch (50 plans), JSONB preservation, Unicode support
  - Validates plan_key stored as NULL

**Verification:**
- `src/scripts/verify-plans.ts` - Database verification utility
  - Shows plan counts by source
  - Displays plan_key status (NULL until Story 2.5)
  - Samples recent plan data

## Implementation Notes

**Status:** ✅ Infrastructure Complete | ✅ 2 Collectors Working | ⏳ 5 Collectors Pending

**Completed:**
- Database helper functions with transaction support
- O2 collector fully working (33 plans from 3 contract lengths) - Playwright
- Smarty collector fully working (32 plans from REST API) - API-based
- All 7 collector stubs with consistent interface
- Orchestration script with error handling and reporting
- 8 database tests (all passing)
- Verification utility for database inspection
- Fixed JSONB query test for unique test data

**Pending Work:**
Each of the 5 remaining stub collectors needs:
1. Research target website structure (inspect HTML/CSS selectors)
2. Implement Playwright navigation and cookie consent handling
3. Extract plan data fields (name, price, data_allowance, contract_term, extras)
4. Convert to PlanData format and call `insertPlans()`
5. Add error handling and logging
6. Write collector-specific tests

**Smarty Implementation Details:**
- **API Endpoint:** `https://smarty.co.uk/api/v3/plans`
- **Authentication:** None required (public API)
- **Request Headers:** Mimics browser request with User-Agent, referer, sec-fetch headers
- **Response Structure:** Nested JSON with `data.attributes.plans[]` array
- **Plan Count:** 32 plans (mix of Classic and Data-only categories)
- **Standard Benefits:** All plans include 7 standard Smarty benefits in `extras` field:
  - Cancel or change anytime
  - No annual price rises
  - No credit check
  - Plan benefits
  - Unlimited call and texts, WIFI calling
  - Fast 5G and 4G data
  - EU Roaming: 12GB fair use limit
- **Data Mapping:**
  - `name` ← `plan.name`
  - `price` ← `£{plan.finalPrice.value}/month`
  - `data_allowance` ← `{plan.dataAllowanceGB}GB` or "Unlimited"
  - `contract_term` ← "1 month" (Smarty is rolling monthly)
  - `extras` ← Standard benefits array
  - Additional fields: `plan_id`, `category`, `category_type`, `description`, `slug`

**Design Decisions:**
- **Raw Data Storage:** Plans stored without normalization, `plan_key=NULL`
- **Transaction Safety:** Batch inserts use transactions, rollback on error
- **Incremental Implementation:** O2 + Smarty working, 5 stubs allows realistic phasing
- **Consistent Interface:** All collectors follow `scrapeAndStore{Telco}Plans()` pattern
- **Sequential Execution:** Collectors run one at a time (avoid rate limiting)
- **Graceful Degradation:** One collector failure doesn't stop others
- **API vs Playwright:** Smarty uses fetch API (faster, more reliable than scraping)

**Test Results:**
```
✅ 60/60 tests passing
  - 19 schema tests
  - 13 connection tests
  - 20 O2 collector tests
  - 8 database operation tests
```

**Database Verification:**
```
O2: 33 plans inserted
Smarty: 32 plans inserted
Total: 65 plans
Plan Keys: 0/65 have keys (all NULL as expected)
Sample data: Raw JSONB preserved correctly, all 7 standard benefits in Smarty plans
```

## QA Results
_To be populated by QA Agent_

