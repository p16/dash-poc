# Story 5.4: Redesign Plan Data Table Page

## Epic
Epic 5: UI Redesign with shadcn/ui Design System

## Status
Ready for Development

## Story

As a data analyst,
I want a redesigned plan data table with filtering, sorting, and export capabilities,
So that I can efficiently explore and analyze plan data to identify patterns and insights.

## Story Context

**Existing System Integration:**
- Integrates with: Existing Plans page at `src/app/dashboard/plans/page.tsx`
- Technology: Next.js 16 App Router, Server Component for data fetching, shadcn/ui Table component
- Follows pattern: Server-side data fetch with Suspense, client-side filtering for responsiveness
- Touch points: Database query for all plans, CSV export functionality

**Design Reference:**
- Wireframe: `docs/front-end-spec.md` - Screen 3: Plan Data Table
- Implementation guide: `docs/IMPLEMENTATION_GUIDE.md` - Section 7 (Plan Data Table)

## Acceptance Criteria

### Functional Requirements

1. **Page Layout**
   - [ ] Header with DashboardHeader component
   - [ ] Breadcrumbs: Dashboard > Plan Data
   - [ ] Page title: "Plan Data" (text-3xl font-bold)
   - [ ] Filter bar with controls and export button
   - [ ] Results count: "Showing X plans"
   - [ ] Data table with scrollable overflow

2. **PlanFilterBar Component**
   - [ ] Create `src/components/dashboard/PlanFilterBar.tsx` as Client Component
   - [ ] Three filter dropdowns: Brand, Data Allowance, Price Range
   - [ ] Brand filter: Multi-select or single select with all brands
   - [ ] Data filter: Ranges (e.g., "0-5GB", "5-20GB", "20-50GB", "50GB+", "Unlimited")
   - [ ] Price filter: Ranges (e.g., "£0-10", "£10-20", "£20-30", "£30+")
   - [ ] "Clear Filters" button to reset all filters
   - [ ] "Export CSV" button aligned to right
   - [ ] Filters update table instantly (<500ms feel)

3. **PlanDataTable Component**
   - [ ] Create `src/components/dashboard/PlanDataTable.tsx` as Client Component
   - [ ] Use shadcn/ui Table component with TableHeader, TableBody, TableRow, TableCell
   - [ ] Columns: Brand, Plan Name, Data, Price, Contract Length, Features, Source
   - [ ] Sticky header on scroll (sticky top-0)
   - [ ] Sortable columns (click header to sort)
   - [ ] Alternating row colors for readability
   - [ ] Features column shows up to 3 badges, truncated if more
   - [ ] Empty state: "No plan data available. Run scrape to collect data."
   - [ ] Responsive: Hide some columns on tablet (768px-1023px)

4. **Client-Side Filtering**
   - [ ] Filter by brand (exact match)
   - [ ] Filter by data allowance (range check)
   - [ ] Filter by price (range check)
   - [ ] Multiple filters combine with AND logic
   - [ ] Table updates immediately when filters change
   - [ ] Show "No plans match filters" if result count is 0
   - [ ] Display filtered count: "Showing X of Y plans"

5. **Sortable Columns**
   - [ ] Click column header to sort ascending
   - [ ] Click again to sort descending
   - [ ] Visual indicator (arrow icon) shows sort direction
   - [ ] Sortable columns: Brand, Data, Price, Contract Length
   - [ ] Plan Name and Features not sortable
   - [ ] Sort applies after filtering

6. **Export CSV Functionality**
   - [ ] "Export CSV" button with Download icon
   - [ ] Exports currently filtered data (not all data)
   - [ ] CSV includes all columns
   - [ ] Filename format: `plans-export-YYYY-MM-DD.csv`
   - [ ] Download triggers automatically
   - [ ] Toast notification on success/error
   - [ ] Handle empty data case gracefully

7. **Loading States**
   - [ ] Suspense boundary with Skeleton loader
   - [ ] Skeleton shows approximate table structure
   - [ ] No flash of empty content
   - [ ] Filter interactions remain responsive during data load

8. **Tablet Responsiveness**
   - [ ] Hide "Source" column on tablet (768px-1023px)
   - [ ] Features column shows 2 badges instead of 3
   - [ ] Horizontal scroll if needed (overflow-x-auto)
   - [ ] Filter dropdowns stack vertically on smaller screens
   - [ ] Table remains usable on 768px viewport

### Integration Requirements

9. **Database Integration**
   - [ ] Query all plans: SELECT * FROM plans ORDER BY brand, price
   - [ ] Include all fields: id, brand, name, data_allowance, price, contract_length, features, source, scrape_timestamp
   - [ ] Handle JSONB features field correctly
   - [ ] Server-side query in async getPlans() function

10. **Data Format**
    - [ ] Price formatted as currency: £X.XX
    - [ ] Contract length: "X months" or "X mo"
    - [ ] Data allowance: Normalized (GB, MB, Unlimited)
    - [ ] Features: Array of strings, rendered as badges

11. **Navigation Integration**
    - [ ] Breadcrumbs link back to dashboard
    - [ ] Header navigation remains functional
    - [ ] No URL state for filters (client-side only for MVP)

### Quality Requirements

12. **Performance**
    - [ ] Initial page load <2 seconds (Server Component + Suspense)
    - [ ] Filtering feels instant (<500ms)
    - [ ] Sorting feels instant (<100ms)
    - [ ] No layout shift during load
    - [ ] Client-side filtering acceptable for ~350 rows

13. **User Experience**
    - [ ] Clear visual feedback when filters applied
    - [ ] Filter state persists during sort operations
    - [ ] Empty states are helpful and actionable
    - [ ] Table scrolls smoothly on all devices
    - [ ] Export downloads without page reload

14. **Testing**
    - [ ] Test with 0 plans (empty state)
    - [ ] Test with ~350 plans (current dataset)
    - [ ] Test all filter combinations
    - [ ] Test sorting on each sortable column
    - [ ] Test CSV export with filtered data
    - [ ] Test CSV export with all data
    - [ ] Test responsive layout on tablet (768px+)
    - [ ] Verify no console errors or warnings

## Technical Notes

### Component Architecture

```
PlansPage (Server Component)
├── DashboardHeader
├── Breadcrumbs
├── Page Title
└── Suspense
    └── PlansContent (Server Component)
        ├── PlanFilterBar (Client Component)
        │   ├── Brand Select
        │   ├── Data Select
        │   ├── Price Select
        │   ├── Clear Filters Button
        │   └── Export CSV Button
        └── PlanDataTable (Client Component)
            ├── Table Header (sticky)
            └── Table Body (rows)
```

### Data Fetching Pattern

```typescript
async function getPlans() {
  const pool = getPool()
  const result = await pool.query(`
    SELECT
      id, brand, name, data_allowance, price,
      contract_length, features, source, scrape_timestamp
    FROM plans
    ORDER BY brand ASC, price ASC
  `)
  return result.rows
}
```

### Client-Side Filter State

```typescript
const [brandFilter, setBrandFilter] = useState<string>('')
const [dataFilter, setDataFilter] = useState<string>('')
const [priceFilter, setPriceFilter] = useState<string>('')
const [sortColumn, setSortColumn] = useState<string>('')
const [sortDirection, setSortDirection] = useState<'asc' | 'desc'>('asc')

const filteredPlans = useMemo(() => {
  return plans
    .filter(plan => !brandFilter || plan.brand === brandFilter)
    .filter(plan => !dataFilter || matchesDataRange(plan.data_allowance, dataFilter))
    .filter(plan => !priceFilter || matchesPriceRange(plan.price, priceFilter))
    .sort((a, b) => sortColumn ? comparePlans(a, b, sortColumn, sortDirection) : 0)
}, [plans, brandFilter, dataFilter, priceFilter, sortColumn, sortDirection])
```

### CSV Export Function

```typescript
const exportToCSV = () => {
  const headers = ['Brand', 'Plan Name', 'Data', 'Price', 'Contract', 'Features', 'Source']
  const rows = filteredPlans.map(plan => [
    plan.brand,
    plan.name,
    plan.data_allowance,
    plan.price.toFixed(2),
    plan.contract_length,
    plan.features.join('; '),
    plan.source
  ])

  const csv = [headers, ...rows].map(row => row.join(',')).join('\n')
  const blob = new Blob([csv], { type: 'text/csv' })
  const url = URL.createObjectURL(blob)
  const a = document.createElement('a')
  a.href = url
  a.download = `plans-export-${new Date().toISOString().split('T')[0]}.csv`
  a.click()
}
```

### Required shadcn/ui Components

```bash
npx shadcn-ui@latest add table
npx shadcn-ui@latest add select  # If not already installed
```

## Definition of Done

- [ ] Plan Data Table page redesigned with new layout
- [ ] PlanFilterBar component created with 3 filters
- [ ] PlanDataTable component created with sortable columns
- [ ] Client-side filtering works instantly
- [ ] Sorting works on all sortable columns
- [ ] CSV export downloads filtered data correctly
- [ ] Empty state displays when no plans available
- [ ] "No matches" state displays when filters return 0 results
- [ ] Loading state with Skeleton works correctly
- [ ] Responsive design works on tablet (768px+)
- [ ] Sticky table header functions correctly
- [ ] All manual testing scenarios passed
- [ ] No console errors or warnings

## Dev Notes

- Use existing database connection from `src/lib/db/`
- Parse features JSONB field correctly (may need JSON.parse)
- Consider using `@tanstack/react-table` for advanced table features (optional)
- Ensure CSV export handles special characters and commas in data
- Test with actual 350+ rows from database
- Sort should maintain stable order for equal values
- Clear filters should reset to initial state (all plans visible)

## Tasks

### Component Development
- [ ] Create PlanFilterBar component with 3 filter dropdowns
- [ ] Create PlanDataTable component with shadcn/ui Table
- [ ] Implement sortable column headers with click handlers
- [ ] Add sticky header functionality to table

### Page Implementation
- [ ] Update Plans page with new layout and components
- [ ] Implement getPlans() server-side function
- [ ] Add Suspense with Skeleton loader
- [ ] Wire up filter state and handlers

### Filtering & Sorting Logic
- [ ] Implement brand filter logic
- [ ] Implement data allowance range filter logic
- [ ] Implement price range filter logic
- [ ] Implement multi-column sort logic
- [ ] Add filter combination (AND logic)
- [ ] Create useMemo for filtered/sorted plans

### CSV Export
- [ ] Implement CSV generation function
- [ ] Add download trigger functionality
- [ ] Handle edge cases (empty data, special characters)
- [ ] Add toast notification for success/error

### Validation
- [ ] Test with 0 plans (empty database)
- [ ] Test with ~350 plans (production data)
- [ ] Test each filter individually
- [ ] Test all filter combinations
- [ ] Test sorting on each sortable column
- [ ] Test CSV export with filtered data
- [ ] Test CSV export with all data (no filters)
- [ ] Verify responsive layout on tablet (768px+)
- [ ] Verify sticky header scrolls correctly
- [ ] Check for console errors/warnings
- [ ] Verify performance (<500ms filter response)

## Dev Agent Record

### Agent Model Used
<!-- AI model info will be recorded here by dev agent -->

### Debug Log References
<!-- Links to debug log entries will be added here -->

### Completion Notes
<!-- Dev agent fills this after story completion -->

### File List
<!-- List of all files created/modified during implementation -->

### Change Log
<!-- Key changes made during implementation -->
