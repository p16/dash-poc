# Story 3.4: API Endpoints for Triggering Analysis

## Status
Draft

## Story
**As a** developer,
**I want** Next.js API routes for triggering analysis operations,
**so that** the dashboard can request LLM insights on demand.

## Acceptance Criteria

1. `POST /api/analysis/full` endpoint created (triggers O2 vs all competitors)
2. `POST /api/analysis/custom` endpoint created (accepts brandA, brandB in request body)
3. Endpoints validate request parameters
4. Endpoints fetch latest plan data from database
5. Endpoints call analysis engine with appropriate data
6. Endpoints return analysis results as JSON
7. Loading states handled (analysis can take minutes)
8. Error responses with meaningful messages for failures
9. Rate limiting applied to prevent abuse

## Tasks / Subtasks

- [ ] Create Full Analysis endpoint (AC: 1)
  - [ ] Create `src/app/api/analysis/full/route.ts`
  - [ ] Implement POST handler
  - [ ] Set up route structure
- [ ] Create Custom Comparison endpoint (AC: 2)
  - [ ] Create `src/app/api/analysis/custom/route.ts`
  - [ ] Implement POST handler
  - [ ] Accept brandA and brandB in request body
- [ ] Implement parameter validation (AC: 3)
  - [ ] Validate request body for custom endpoint
  - [ ] Validate brands exist in database
  - [ ] Return error if validation fails
- [ ] Fetch plan data (AC: 4)
  - [ ] Query database for latest plan data
  - [ ] Filter by brands if needed (custom endpoint)
  - [ ] Structure data for analysis engine
- [ ] Call analysis engine (AC: 5)
  - [ ] Call analysis engine with appropriate parameters
  - [ ] Pass plan data to engine
  - [ ] Handle async operation
- [ ] Return analysis results (AC: 6)
  - [ ] Format analysis as JSON
  - [ ] Return with appropriate status code
  - [ ] Include metadata if needed
- [ ] Handle loading states (AC: 7)
  - [ ] Document that analysis can take minutes
  - [ ] Consider async/background processing if needed
  - [ ] Return appropriate response format
- [ ] Implement error handling (AC: 8)
  - [ ] Catch and handle errors
  - [ ] Return meaningful error messages
  - [ ] Use appropriate HTTP status codes
- [ ] Implement rate limiting (AC: 9)
  - [ ] Add rate limiting middleware or logic
  - [ ] Prevent abuse of API endpoints
  - [ ] Return rate limit errors appropriately

## Dev Notes

### Source Tree
- API routes: `src/app/api/analysis/full/route.ts`, `src/app/api/analysis/custom/route.ts`
- Analysis engine: `src/lib/llm/analysis.ts` (from Story 3.3)
- Database: `src/lib/db/` (from Story 1.2, 2.1)

### Technical Stack
- Next.js API routes (App Router)
- Analysis engine integration
- Rate limiting for API protection

### Testing
- Test file location: `tests/integration/api/analysis/` (to be created)
- Test framework: Jest
- Test API endpoints with mocked analysis engine
- Test error handling and rate limiting

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Story extracted from PRD | Architect |

## Dev Agent Record

### Agent Model Used
_To be populated by Dev Agent_

### Debug Log References
_To be populated by Dev Agent_

### Completion Notes List
_To be populated by Dev Agent_

### File List
_To be populated by Dev Agent_

## QA Results
_To be populated by QA Agent_

