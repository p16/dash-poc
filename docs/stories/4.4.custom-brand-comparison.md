# Story 4.4: Custom Brand Comparison Tool

## Status
Draft

## Story
**As a** user,
**I want** to select two brands and trigger custom comparison analysis,
**so that** I can explore specific competitive matchups on demand.

## Acceptance Criteria

1. Form with two dropdowns to select Brand A and Brand B
2. Dropdowns populated with available telco brands from scraped data
3. "Compare" button triggers custom analysis API call to `/api/analysis/custom` (from Story 3.4)
4. Loading indicator while analysis generates (analysis can take 2-5 minutes)
5. Progress message shown during long-running analysis (e.g., "Analysis in progress... This may take up to 5 minutes")
6. Results displayed in analysis results view format (using AnalysisResults component from Story 4.3)
7. Error handling for failed analysis requests (timeout, API errors, no data)
8. Form validation prevents selecting same brand twice
9. Caching prevents duplicate analysis requests for same brand pair within session

## Tasks / Subtasks

- [ ] Create comparison form component (AC: 1)
  - [ ] Create `src/components/dashboard/CustomComparison.tsx`
  - [ ] Add two dropdown selects for Brand A and Brand B
  - [ ] Add "Compare" button
  - [ ] Style with Tailwind CSS
- [ ] Populate brand dropdowns (AC: 2)
  - [ ] Query: `SELECT DISTINCT source FROM plans ORDER BY source`
  - [ ] Fetch available brands from database
  - [ ] Populate dropdowns with brand list
- [ ] Implement comparison trigger (AC: 3)
  - [ ] Call `POST /api/analysis/custom` endpoint (from Story 3.4)
  - [ ] Pass brandA and brandB in request body: `{ brandA: string, brandB: string }`
  - [ ] Handle API response
- [ ] Add loading indicator (AC: 4, 5)
  - [ ] Show loading state during analysis (can take 2-5 minutes)
  - [ ] Display progress message: "Analysis in progress... This may take up to 5 minutes"
  - [ ] Disable form during loading
  - [ ] Show estimated time remaining if possible
- [ ] Display results (AC: 6)
  - [ ] Use AnalysisResults component from Story 4.3
  - [ ] Pass custom analysis data to component
  - [ ] Display results after analysis completes
  - [ ] Check for cached results (analysisResult.cached === true)
- [ ] Implement error handling (AC: 7)
  - [ ] Catch API errors (400, 404, 500, 503)
  - [ ] Display error messages to user
  - [ ] Handle timeout errors (analysis >10 minutes)
  - [ ] Handle "no data" errors (404 - brands not found)
- [ ] Add form validation (AC: 8)
  - [ ] Prevent selecting same brand twice
  - [ ] Show validation error if same brand selected
  - [ ] Disable compare button if invalid
- [ ] Implement caching check (AC: 9)
  - [ ] Check if analysis already exists for brand pair
  - [ ] Show cached results immediately if available
  - [ ] Display "cached" indicator to user

## Dev Notes

### Source Tree
- Custom comparison component: `src/components/dashboard/CustomComparison.tsx`
- Analysis results component: `src/components/analysis/AnalysisResults.tsx` (from Story 4.3)
- API endpoint: `src/app/api/analysis/custom/route.ts` (from Story 3.4)
- Database queries: `src/lib/db/queries.ts` (to be created)

### Technical Stack
- React Client Component for form interactivity
- Next.js API routes for analysis trigger
- Tailwind CSS for styling

### Testing
- Test file location: `tests/integration/components/dashboard/CustomComparison.test.tsx` (to be created)
- Test framework: Jest + React Testing Library
- Test form validation, API calls, error handling

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Story extracted from PRD | Architect |

## Dev Agent Record

### Agent Model Used
_To be populated by Dev Agent_

### Debug Log References
_To be populated by Dev Agent_

### Completion Notes List
_To be populated by Dev Agent_

### File List
_To be populated by Dev Agent_

## QA Results
_To be populated by QA Agent_

