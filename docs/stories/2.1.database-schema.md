# Story 2.1: Database Schema Design & Implementation

## Status
Draft

## Story
**As a** developer,
**I want** a well-designed database schema for storing plan data and analysis results,
**so that** data can be efficiently queried and maintained.

## Acceptance Criteria

1. `plans` table created with columns:
   - `id` (primary key)
   - `source` (text: telco name or aggregator)
   - `plan_data` (JSONB: normalized plan details)
   - `scrape_timestamp` (timestamptz: when scraped)
   - `plan_id` (text: unique identifier from source)
2. `analyses` table created with columns:
   - `id` (primary key)
   - `comparison_type` (text: "full" or "custom")
   - `brands` (text array: brands being compared)
   - `analysis_result` (JSONB: LLM-generated analysis)
   - `plan_ids` (text array: references to plan data used)
   - `created_at` (timestamptz)
3. Indexes created on `plans.scrape_timestamp`, `plans.source`, `analyses.created_at`
4. Database migration SQL script created and documented
5. Schema successfully deployed to Neon database
6. Connection pooling configured for efficient database access

## Tasks / Subtasks

- [ ] Design database schema (AC: 1, 2)
  - [ ] Design `plans` table structure
  - [ ] Design `analyses` table structure
  - [ ] Review schema with team/self
- [ ] Create migration SQL script (AC: 4)
  - [ ] Create `migrations/001_initial_schema.sql`
  - [ ] Define `plans` table with all columns
  - [ ] Define `analyses` table with all columns
  - [ ] Add indexes on specified columns
  - [ ] Document migration script
- [ ] Deploy schema to Neon (AC: 5)
  - [ ] Connect to Neon database
  - [ ] Execute migration SQL script
  - [ ] Verify tables created successfully
  - [ ] Verify indexes created
- [ ] Configure connection pooling (AC: 6)
  - [ ] Update `src/lib/db/connection.ts`
  - [ ] Configure `pg.Pool` with appropriate settings
  - [ ] Test connection pooling works
- [ ] Create TypeScript types (AC: 1, 2)
  - [ ] Create `src/types/database.ts`
  - [ ] Define types for `plans` table
  - [ ] Define types for `analyses` table
  - [ ] Export types for use in code

## Dev Notes

### Source Tree
- Migration files: `migrations/001_initial_schema.sql`
- Database types: `src/types/database.ts`
- Connection utility: `src/lib/db/connection.ts` (from Story 1.2)

### Technical Stack
- PostgreSQL (Neon) with JSONB for flexible data storage
- `pg` (node-postgres) with connection pooling
- Manual migrations (no automatic migration on deploy for MVP)

### Testing
- Test file location: `tests/integration/db/schema.test.ts` (to be created)
- Test framework: Jest
- Test table creation, indexes, and basic queries
- Test connection pooling

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Story extracted from PRD | Architect |

## Dev Agent Record

### Agent Model Used
_To be populated by Dev Agent_

### Debug Log References
_To be populated by Dev Agent_

### Completion Notes List
_To be populated by Dev Agent_

### File List
_To be populated by Dev Agent_

## QA Results
_To be populated by QA Agent_

