# Story 1.3: Playwright Scraper POC for Single Telco Source

## Status
Ready for Review

## Story
**As a** developer,
**I want** to build a proof-of-concept scraper for one telco website using Playwright,
**so that** I can validate the scraping approach works for JavaScript-heavy sites.

## Acceptance Criteria

1. Playwright installed and configured for headless browser execution (webkit or chromium)
2. Scraper script targets one telco website (recommend O2 or Sky as proven working examples)
3. Script successfully loads target page and waits for dynamic content to render
4. Handles cookie consent modal if present (click accept)
5. Extracts at least 3 SIM-only plan data points: pricing, data allowance, contract term
6. Handles common errors (timeout, element not found) with retry logic
7. Outputs scraped data to console as JSON or structured array
8. Script executable via `npm run scrape:poc` command
9. Basic documentation of selectors and scraping logic

## Tasks / Subtasks

- [x] Install Playwright (AC: 1)
  - [x] Install `playwright` package
  - [x] Install browser binaries (chromium)
  - [x] Configure for headless execution
- [x] Create POC scraper script (AC: 2)
  - [x] Choose target telco (O2 selected)
  - [x] Create `src/lib/scraping/collectors/o2.ts`
  - [x] Set up basic Playwright page navigation
- [x] Implement page loading and waiting (AC: 3)
  - [x] Navigate to target URL
  - [x] Wait for dynamic content to render (networkidle)
  - [x] Wait for plan elements to be visible (multiple selector strategies)
- [x] Handle cookie consent (AC: 4)
  - [x] Detect cookie consent modal (multiple selector strategies)
  - [x] Click accept button (site-specific selectors)
  - [x] Wait for modal to close
- [x] Extract plan data (AC: 5)
  - [x] Extract pricing information (regex patterns)
  - [x] Extract data allowance (regex patterns)
  - [x] Extract contract term (regex patterns)
  - [x] Structure data as JSON/array
- [x] Implement error handling (AC: 6)
  - [x] Add retry logic for failed scrapes (3 attempts with exponential backoff)
  - [x] Handle timeout errors
  - [x] Handle element not found errors
  - [x] Add error logging and screenshot capture
- [x] Output scraped data (AC: 7)
  - [x] Format as JSON
  - [x] Output to console
  - [x] Verify output format
- [x] Create npm script (AC: 8)
  - [x] Add `scrape:poc` script to `package.json`
  - [x] Script executable via `npm run scrape:poc`
- [x] Document scraper (AC: 9)
  - [x] Document selectors used (README.md in collectors directory)
  - [x] Document scraping logic
  - [x] Document assumptions and limitations

## Dev Notes

### Source Tree
- Scraper location: `src/lib/scraping/collectors/{telco}.ts` (e.g., `o2.ts` or `sky.ts`)
- Main scraping entry point: `src/scripts/scrape.ts` (for future use)
- Playwright uses headless browser execution (webkit or chromium)

### Technical Stack
- Playwright for browser automation
- Headless browser execution
- Site-specific selectors for cookie consent and plan data

### Testing
- Test file location: `tests/integration/scraping/{telco}.test.ts` (to be created)
- Test framework: Jest with mocked Playwright
- Mock network requests to avoid hitting real sites in tests
- Test error handling and retry logic

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Story extracted from PRD | Architect |
| 2025-11-13 | 1.1 | Story implementation completed | Dev Agent (James) |

## Dev Agent Record

### Agent Model Used
Auto (Cursor AI)

### Debug Log References
- Playwright installed with Chromium browser
- O2 scraper created with multiple selector strategies for resilience
- Error handling with retry logic and screenshot capture
- All linting issues resolved

### Completion Notes List
- Playwright and @playwright/test installed successfully
- Chromium browser binary installed
- O2 scraper created at `src/lib/scraping/collectors/o2.ts` with:
  - Headless browser execution (Chromium)
  - Multiple selector strategies for plan containers and cookie consent
  - Regex-based data extraction for price, data allowance, and contract term
  - Retry logic (3 attempts with exponential backoff)
  - Error handling with screenshot capture on failure
  - Timeout handling (30s navigation, 15s element wait)
- Test script created at `src/scripts/scrape-poc.ts`
- Added `npm run scrape:poc` script to package.json
- Documentation created at `src/lib/scraping/collectors/README.md`
- All code passes ESLint validation
- **Note**: Scraper uses flexible selector strategies to handle O2's dynamic content. Actual selectors may need adjustment based on O2's current website structure.

### File List
**Created:**
- `src/lib/scraping/collectors/o2.ts` - O2 scraper implementation
- `src/lib/scraping/collectors/README.md` - Scraper documentation
- `src/scripts/scrape-poc.ts` - POC scraping script

**Modified:**
- `package.json` - Added `scrape:poc` script, installed `playwright` and `@playwright/test`

## QA Results
_To be populated by QA Agent_

