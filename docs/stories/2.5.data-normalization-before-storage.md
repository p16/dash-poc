# Story 2.5: Data Normalization Before Storage

## Status
Done

## Story
**As a** developer,
**I want** a normalization layer that processes raw scraped data before database insertion,
**so that** plan data from different sources is stored in a consistent format for analysis.

## Dependencies
- Story 2.1: Database Schema Design (Done)
- Story 2.2: Data Collectors - Telcos (Must complete first - provides real data formats)
- Story 2.3: Uswitch API Integration (Must complete first - provides API data formats)
- Story 2.4: Unified Data Collection (Must complete first - provides orchestration context)

**Note:** This story must be implemented AFTER Stories 2.2-2.4 to understand actual data format variations from all sources.

## Acceptance Criteria

1. Normalization function processes raw scraped data from all sources (7 telcos + Uswitch API)
2. Normalizes data allowance formats based on ACTUAL formats discovered:
   - Examples: "Unlimited", "100GB", "100 GB", "100G" → standardized format
3. Normalizes pricing formats based on ACTUAL formats discovered:
   - Examples: "£10/mo", "10 GBP per month", "£10 a month", "10.00" → standardized format
4. Normalizes contract terms based on ACTUAL formats discovered:
   - Examples: "12 months", "12-month", "1 year", "12m" → standardized format
5. Generates `plan_key` field for historical tracking:
   - Format: `{source}-{data_allowance}-{contract_term}` (e.g., "O2-10GB-12months")
   - Handles edge cases (Unlimited, PAYG, variable terms)
6. Handles multiple input formats from real sources:
   - Scraped HTML text (Playwright collectors)
   - Structured objects (some telco sites)
   - API JSON responses (Smarty, Uswitch)
7. Error handling for malformed data:
   - Gracefully handles null, undefined, missing fields
   - Logs warnings for unexpected formats
   - Continues processing (doesn't fail entire batch)
8. Integration with all collectors:
   - Each collector calls normalization before database insertion
   - Normalized data written to `plans.plan_data` JSONB field
   - `plan_key` populated in `plans.plan_key` field
9. Unit tests covering ACTUAL format variations discovered across all sources
10. Documentation of normalization rules and format mappings per source

## Tasks / Subtasks

- [x] Analyze real data formats from Stories 2.2-2.4 (AC: 1-6)
  - [x] Collect sample outputs from all 7 telco collectors
  - [x] Collect sample outputs from Uswitch API
  - [x] Document format variations per source
  - [x] Identify normalization patterns
- [x] Create normalization utility (AC: 1-6)
  - [x] Create `src/lib/scraping/normalize.ts`
  - [x] Implement data allowance normalization
  - [x] Implement pricing normalization
  - [x] Implement contract term normalization
  - [x] Implement plan_key generation logic
  - [x] Handle input format variations (HTML text, objects, JSON)
- [x] Implement error handling (AC: 7)
  - [x] Handle null/undefined/missing fields gracefully
  - [x] Add warning logs for unexpected formats
  - [x] Ensure processing continues on errors
- [x] Integrate with collectors (AC: 8)
  - [x] Update all telco collectors to call normalization
  - [x] Update Uswitch collector to call normalization
  - [x] Ensure normalized data written to database
  - [x] Ensure plan_key populated correctly
- [x] Write comprehensive tests (AC: 9)
  - [x] Create `src/lib/scraping/__tests__/normalize.test.ts`
  - [x] Test all discovered format variations
  - [x] Test plan_key generation edge cases
  - [x] Test error handling scenarios
  - [x] Achieve 80%+ coverage for normalization logic
- [x] Document normalization rules (AC: 10)
  - [x] Create normalization mapping documentation
  - [x] Document per-source format quirks
  - [x] Add inline code comments explaining rules

## Dev Notes

### Source Tree
- Normalization utility: `src/lib/scraping/normalize.ts`
- Test file: `src/lib/scraping/__tests__/normalize.test.ts`
- Integration points: All collectors in `src/lib/scraping/collectors/`

### Technical Stack
- TypeScript with strict types for normalization functions
- Vitest for testing
- Structured logging for warnings/errors

### Data Flow
```
Collector (raw scrape) → normalize() → Database (plans table)
                              ↓
                      Standardized format:
                      - plan_data: JSONB (normalized)
                      - plan_key: TEXT (generated)
```

### Normalization Philosophy
- **Preserve original data**: Store raw data alongside normalized data for auditing
- **Fail gracefully**: Log warnings but continue processing
- **Source-specific rules**: Document quirks per telco/aggregator
- **plan_key consistency**: Same plan from multiple scrapes gets same key

### Testing Strategy
- Test file location: `src/lib/scraping/__tests__/normalize.test.ts` (co-located)
- Test framework: Vitest (aligned with project standards)
- Test with REAL data samples from all sources
- Coverage target: 80%+ for normalization logic

### plan_key Generation Strategy
Format: `{source}-{data_allowance}-{contract_term}`

Examples:
- O2, 10GB, 12 months → `O2-10GB-12months`
- Vodafone, Unlimited, 24 months → `Vodafone-Unlimited-24months`
- Three, 50GB, 1 month → `Three-50GB-1month`
- Sky, 100GB, PAYG → `Sky-100GB-PAYG`

Edge cases to handle:
- Unlimited data
- Pay-as-you-go (PAYG) plans
- Variable contract terms
- Promotional plans with changing allowances

## Relationship to Story 1.4

**Story 2.5** (this story):
- Focus: Normalization BEFORE database insertion
- Timing: After data collection (2.2-2.4), before refactoring (1.4)
- Scope: Process raw data into consistent format for storage
- Output: Populated `plan_data` JSONB and `plan_key` fields

**Story 1.4** (Data Normalization Utility - Refactoring):
- Focus: Refactor/improve existing normalization based on production experience
- Timing: After Epic 2 complete, before Epic 3
- Scope: Optimize normalization logic, improve error handling, refine plan_key generation
- Output: Enhanced normalization utility with lessons learned

Story 2.5 provides the initial working normalization. Story 1.4 will refine it based on real-world usage.

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-17 | 1.0 | Story created to handle normalization between data collection and storage | PM Agent (John) |
| 2025-11-18 | 1.1 | Status changed to Ready - all dependencies satisfied (Stories 2.1-2.4 complete, 356 plans available for analysis) | PM Agent (John) |
| 2025-01-18 | 2.0 | Implementation complete - all 10 ACs satisfied, 69 tests passing, normalization integrated across all 8 collectors | Dev Agent (James) |
| 2025-01-18 | 3.0 | QA PASS - Story marked Done, Epic 2 now complete | QA Agent (Sarah) |

## Dev Agent Record

### Agent Model Used
GitHub Copilot (Claude 3.5 Sonnet) - 2025-01-18

### Implementation Summary
Implemented comprehensive data normalization system to standardize raw scraped data from all 8 sources (O2, Vodafone, Sky, Tesco, Three, Giffgaff, Smarty, Uswitch) before database storage. Started by analyzing 356 existing plans to discover actual format variations across sources. Created normalization utility with source-aware rules to handle discovered quirks (Three uses pence integers, Uswitch uses numeric MB, Smarty has fractional GB, etc.). Developed 69 unit tests covering all real-world format patterns. Integrated normalization into all 8 collectors and updated database insertion functions to properly extract and store plan_key for historical tracking.

### Completion Notes List
- Analyzed actual data formats from all 8 sources (356 plans total from database)
- Discovered source-specific format quirks requiring custom normalization rules
- Created comprehensive normalization utility (`normalize.ts`) with 5 main functions:
  - `normalizeDataAllowance()` - handles GB/MB/Unlimited variants
  - `normalizePrice()` - handles £/GBP/pence/Unknown variants
  - `normalizeContractTerm()` - handles months/years/PAYG/numeric variants
  - `generatePlanKey()` - creates unique tracking key per plan
  - `normalizePlanData()` - main integration function
- Implemented 69 unit tests with 100% pass rate covering all discovered format variations
- Fixed critical bug in database insertion functions (insertPlan/insertPlans) to properly extract plan_key from normalized data
- Integrated normalization into all 8 collectors before database insertion
- Verified normalization working correctly with Smarty collector (plan_key populated: "Smarty-Unlimited-1month", etc.)
- Created comprehensive documentation of normalization rules and format mappings (`docs/NORMALIZATION_RULES.md`)
- All 10 acceptance criteria fully satisfied

### File List

**Created:**
- `src/lib/scraping/normalize.ts` - Normalization utility (370 lines, 5 main functions)
- `src/lib/scraping/__tests__/normalize.test.ts` - Test suite (69 tests, 100% pass)
- `src/scripts/analyze-data-formats.ts` - Format analysis tool (samples 3 plans per source)
- `src/scripts/verify-normalization.ts` - Verification utility (checks plan_key population)
- `src/scripts/debug-normalization.ts` - Single-plan normalization test utility
- `src/scripts/clear-smarty.ts` - Test data cleanup utility
- `docs/NORMALIZATION_RULES.md` - Complete normalization rules documentation

**Modified:**
- `src/lib/db/plans.ts` - Updated insertPlan() and insertPlans() to extract plan_key from normalized data (critical fix)
- `src/lib/scraping/collectors/o2.ts` - Added normalization integration (import + call before insertPlans)
- `src/lib/scraping/collectors/vodafone.ts` - Added normalization integration
- `src/lib/scraping/collectors/sky.ts` - Added normalization integration
- `src/lib/scraping/collectors/tesco.ts` - Added normalization integration
- `src/lib/scraping/collectors/three.ts` - Added normalization integration
- `src/lib/scraping/collectors/giffgaff.ts` - Added normalization integration
- `src/lib/scraping/collectors/smarty.ts` - Added normalization integration
- `src/lib/scraping/collectors/uswitch.ts` - Added normalization integration

## QA Results

**QA Date**: 2025-01-18
**QA Agent**: Sarah
**Quality Gate**: docs/qa/gates/2.5-data-normalization.yml
**Decision**: **PASS** ✅

### Summary
All 10 acceptance criteria fully satisfied with exceptional implementation quality. Comprehensive normalization system handles all 8 data sources with source-specific quirks properly addressed. Test coverage excellent (69 tests, 100% pass). Integration verified across all collectors and database functions. Documentation comprehensive.

### Key Achievements
- ✅ All 8 collectors integrated with normalization
- ✅ Handles source-specific quirks (Three pence, Uswitch MB, Smarty fractional GB)
- ✅ plan_key generation working with proper database storage
- ✅ 69 comprehensive tests, 100% pass rate
- ✅ 345-line documentation guide created
- ✅ Graceful error handling with fallbacks

### Code Quality: EXCELLENT
- Clear separation of concerns (5 focused functions)
- Comprehensive error handling
- Excellent maintainability with inline documentation
- Proper TypeScript typing

### Test Quality: EXCELLENT
- 69 tests covering all real-world format variations
- 100% pass rate
- Tests based on actual collector data, not hypothetical
- Edge cases properly covered

### Minor Recommendations (Non-Blocking)
- Future: Update PlanData TypeScript interface to include optional plan_key
- Future: Add monitoring for plan_key population rates in production
- Future: Consider configuration file for normalization thresholds

### Epic Impact
**Story 2.5 is the final story in Epic 2 "Data Collection Infrastructure"**

With this PASS decision, Epic 2 is now **COMPLETE** - all 5 stories done:
- Story 2.1: Database Schema Design ✅
- Story 2.2: Data Collectors - Telcos ✅
- Story 2.3: Uswitch API Integration ✅
- Story 2.4: Unified Data Collection ✅
- Story 2.5: Data Normalization Before Storage ✅

**Next Step**: Epic 3 "Analysis Engine" can now proceed
