# Story 1.4: Data Normalization Utility

## Status
Draft

## Story
**As a** developer,
**I want** a utility function to normalize varying data formats from different sources,
**so that** plan data (scraped arrays, structured objects, API responses) can be compared consistently.

## Acceptance Criteria

1. Utility function normalizes data allowances (e.g., "Unlimited", "100GB", "100 GB" → standardized format)
2. Utility function normalizes pricing (e.g., "£10/mo", "10 GBP per month", "£10 a month" → standardized format)
3. Handles multiple input formats:
   - Scraped text arrays (e.g., O2, Sky format: `["plan name", "£10", "100GB", ...]`)
   - Structured objects (e.g., Vodafone format: `{ name, description, details, extendedDetails }`)
   - API JSON responses (e.g., Smarty, Uswitch format: structured JSON with nested properties)
4. Unit tests cover common format variations across all source types
5. Function handles edge cases (null, undefined, malformed inputs, missing fields) gracefully
6. Documentation of normalization rules and assumptions per source type

## Tasks / Subtasks

- [ ] Create normalization utility file (AC: 1, 2, 3)
  - [ ] Create `src/lib/scraping/normalize.ts`
  - [ ] Implement `normalizeDataAllowance()` function
  - [ ] Implement `normalizePrice()` function
  - [ ] Create main `normalizePlanData()` function
- [ ] Implement data allowance normalization (AC: 1)
  - [ ] Handle "Unlimited" → standardized format
  - [ ] Handle "100GB", "100 GB" → standardized format
  - [ ] Handle other variations
- [ ] Implement price normalization (AC: 2)
  - [ ] Handle "£10/mo" → number
  - [ ] Handle "10 GBP per month" → number
  - [ ] Handle "£10 a month" → number
  - [ ] Extract numeric value in GBP
- [ ] Handle multiple input formats (AC: 3)
  - [ ] Support scraped text arrays (O2, Sky format)
  - [ ] Support structured objects (Vodafone format)
  - [ ] Support API JSON responses (Smarty, Uswitch format)
  - [ ] Create type definitions for input formats
- [ ] Write unit tests (AC: 4)
  - [ ] Create `tests/unit/scraping/normalize.test.ts`
  - [ ] Test data allowance normalization variations
  - [ ] Test price normalization variations
  - [ ] Test all input format types
  - [ ] Achieve good test coverage
- [ ] Handle edge cases (AC: 5)
  - [ ] Handle null/undefined inputs
  - [ ] Handle malformed inputs
  - [ ] Handle missing fields
  - [ ] Add appropriate error handling
- [ ] Document normalization rules (AC: 6)
  - [ ] Document rules per source type
  - [ ] Document assumptions
  - [ ] Add JSDoc comments to functions

## Dev Notes

### Source Tree
- Normalization utility: `src/lib/scraping/normalize.ts`
- Type definitions: `src/types/plan.ts` (to be created)
- Test file: `tests/unit/scraping/normalize.test.ts`

### Technical Stack
- TypeScript for type safety
- Utility functions for data transformation
- Support for multiple input formats

### Testing
- Test file location: `tests/unit/scraping/normalize.test.ts`
- Test framework: Jest
- Coverage target: 60%+ for critical business logic
- Test all format variations and edge cases

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Story extracted from PRD | Architect |

## Dev Agent Record

### Agent Model Used
_To be populated by Dev Agent_

### Debug Log References
_To be populated by Dev Agent_

### Completion Notes List
_To be populated by Dev Agent_

### File List
_To be populated by Dev Agent_

## QA Results
_To be populated by QA Agent_

