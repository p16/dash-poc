# Story 2.3: API Integration for Aggregator Source (Uswitch)

## Status
Draft

## Story
**As a** developer,
**I want** to integrate with Uswitch GraphQL API for aggregator data,
**so that** aggregated market data complements direct telco sources.

## Acceptance Criteria

1. Uswitch API client module created using GraphQL endpoint (`https://www.uswitch.com/mobiles/graphql`)
2. Implements proper headers (user-agent, cookies, CSRF token, etc.) for API authentication
3. Fetches SIM-only plan data across multiple telcos from Uswitch listings
4. Handles pagination to retrieve complete dataset (configurable limit/offset)
5. Parses GraphQL response and extracts plan details
6. Normalized data stored in `plans` table with `source='Uswitch'`
7. Deduplication logic to handle plans appearing on both telco sites and Uswitch
8. Error handling for API failures, rate limiting, invalid responses
9. `npm run scrape:uswitch` command executes Uswitch API integration
10. Helper function `fetchAllUswitchDeals()` supports bulk data retrieval with automatic pagination

## Tasks / Subtasks

- [ ] Create Uswitch API client (AC: 1)
  - [ ] Create `src/lib/scraping/collectors/uswitch.ts`
  - [ ] Set up GraphQL endpoint connection
  - [ ] Create GraphQL query structure
- [ ] Implement authentication headers (AC: 2)
  - [ ] Add user-agent header
  - [ ] Add cookies if required
  - [ ] Add CSRF token if required
  - [ ] Test authentication works
- [ ] Implement data fetching (AC: 3)
  - [ ] Create GraphQL query for SIM-only plans
  - [ ] Fetch data across multiple telcos
  - [ ] Test data retrieval
- [ ] Implement pagination (AC: 4)
  - [ ] Handle limit/offset parameters
  - [ ] Create `fetchAllUswitchDeals()` helper function
  - [ ] Implement automatic pagination
  - [ ] Test pagination logic
- [ ] Parse GraphQL response (AC: 5)
  - [ ] Extract plan details from response
  - [ ] Structure data for normalization
  - [ ] Test parsing logic
- [ ] Store normalized data (AC: 6)
  - [ ] Pass data through normalization utility
  - [ ] Store in `plans` table with `source='Uswitch'`
  - [ ] Include proper metadata
- [ ] Implement deduplication (AC: 7)
  - [ ] Detect duplicate plans (same telco, same plan)
  - [ ] Handle deduplication logic
  - [ ] Document deduplication strategy
- [ ] Implement error handling (AC: 8)
  - [ ] Handle API failures
  - [ ] Handle rate limiting
  - [ ] Handle invalid responses
  - [ ] Add retry logic if appropriate
- [ ] Create npm script (AC: 9)
  - [ ] Add `scrape:uswitch` script to `package.json`
  - [ ] Test script execution

## Dev Notes

### Source Tree
- Uswitch collector: `src/lib/scraping/collectors/uswitch.ts`
- GraphQL client using `fetch` API
- Normalization: `src/lib/scraping/normalize.ts` (from Story 1.4)
- Database: `src/lib/db/` (from Story 1.2, 2.1)

### Technical Stack
- GraphQL API client (fetch)
- Pagination handling
- Deduplication logic
- Normalization utility

### Testing
- Test file location: `tests/integration/scraping/collectors/uswitch.test.ts` (to be created)
- Test framework: Jest with mocked GraphQL responses
- Test pagination, parsing, and error handling
- Test deduplication logic

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-XX | 1.0 | Story extracted from PRD | Architect |

## Dev Agent Record

### Agent Model Used
_To be populated by Dev Agent_

### Debug Log References
_To be populated by Dev Agent_

### Completion Notes List
_To be populated by Dev Agent_

### File List
_To be populated by Dev Agent_

## QA Results
_To be populated by QA Agent_

